<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>思路 | TypeScript Axios</title>
    <meta name="description" content="Study axios and typescript knowledge">
    <link rel="stylesheet" href="/typescript-axios/assets/style.49eed234.css">
    <link rel="modulepreload" href="/typescript-axios/assets/Home.50401ab3.js">
    <link rel="modulepreload" href="/typescript-axios/assets/app.9770fa93.js">
    <link rel="modulepreload" href="/typescript-axios/assets/requirement.md.9d6431d0.lean.js">
    
    <meta name="twitter:title" content="思路 | TypeScript Axios">
  <meta property="og:title" content="思路 | TypeScript Axios">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/typescript-axios/" aria-label="TypeScript Axios, back to home" data-v-675d8756 data-v-cc01ef16><!----> TypeScript Axios</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/wangkaiwd/typescript-axios" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/wangkaiwd/typescript-axios" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/typescript-axios/build">build</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/typescript-axios/publish">publish</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/typescript-axios/requirement">requirement</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#思路">思路</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#实现一个最简单的ajax请求">实现一个最简单的ajax请求</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#params-将参数拼接到url中">params: 将参数拼接到url中</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#为什么要这样处理">为什么要这样处理?</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#data-将参数添加到请求体中">data: 将参数添加到请求体中</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#处理请求头">处理请求头</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#处理返回">处理返回</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#错误处理">错误处理</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#扩展接口">扩展接口</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#拦截器">拦截器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#配置化">配置化</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#取消请求">取消请求</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#整体思路">整体思路</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#复杂点">复杂点</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#更多功能">更多功能</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#authorization">Authorization</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#materials">materials</a><!----></li></ul></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/typescript-axios/notes">notes</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/typescript-axios/test-case">test-case</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h2 id="思路" tabindex="-1">思路 <a class="header-anchor" href="#思路" aria-hidden="true">#</a></h2><h3 id="实现一个最简单的ajax请求" tabindex="-1">实现一个最简单的<code>ajax</code>请求 <a class="header-anchor" href="#实现一个最简单的ajax请求" aria-hidden="true">#</a></h3><h3 id="params-将参数拼接到url中" tabindex="-1"><code>params</code>: 将参数拼接到<code>url</code>中 <a class="header-anchor" href="#params-将参数拼接到url中" aria-hidden="true">#</a></h3><h3 id="为什么要这样处理" tabindex="-1">为什么要这样处理? <a class="header-anchor" href="#为什么要这样处理" aria-hidden="true">#</a></h3><ul><li>数组</li><li>对象</li><li>Date</li><li>特殊字符 <ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent" target="_blank" rel="noopener noreferrer">encodeURIComponent</a></li><li><a href="https://stackoverflow.com/questions/75980/when-are-you-supposed-to-use-escape-instead-of-encodeuri-encodeuricomponent" target="_blank" rel="noopener noreferrer">When are you supposed to use escape instead of encodeURI/encodeURIComponent</a></li></ul></li></ul><p>有什么规范可以参考吗？</p><h4 id="问题" tabindex="-1">问题 <a class="header-anchor" href="#问题" aria-hidden="true">#</a></h4><ul><li><code>params: {a:{x:1}}</code>属性值依旧是对象的情况处理和想象的不一样？</li></ul><h3 id="data-将参数添加到请求体中" tabindex="-1"><code>data</code>: 将参数添加到请求体中 <a class="header-anchor" href="#data-将参数添加到请求体中" aria-hidden="true">#</a></h3><h4 id="自己的思路" tabindex="-1">自己的思路 <a class="header-anchor" href="#自己的思路" aria-hidden="true">#</a></h4><p>根据请求头不同，要进行不同的处理：</p><ul><li><code>application/json</code></li><li><code>application/x-www-form-urlencoded</code></li><li><code>multipart/form-data</code></li><li>other format</li></ul><p>如果是普通对象，转换为<code>JSON</code>字符串，其它类型的内容，直接交给服务端处理？</p><h4 id="库的思路" tabindex="-1">库的思路 <a class="header-anchor" href="#库的思路" aria-hidden="true">#</a></h4><p><code>send</code>方法传入的请求体的类型如下：</p><ul><li>Document</li><li>XMLHttpRequestBodyInit</li></ul><p>服务端会根据不同的请求<code>Content-Type</code>来解析请求<code>body</code>:</p><ul><li>通过流的形式来获取到对应的参数</li><li>通过<code>Content-Type</code>来解析参数 <ul><li><code>application/json</code></li><li><code>application/x-www-form-urlencoded</code></li><li><code>multipart/form-data</code></li><li><code>text/plain</code></li></ul></li></ul><p>如果传入的参数可以被<code>JSON.parse</code>进行解析并且<code>headers</code>中没有设置<code>Content-Type</code>，<code>axios</code>会默认设置<code>application/json</code>请求头</p><p>参考资料：</p><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/POST" target="_blank" rel="noopener noreferrer">post</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send#parameters" target="_blank" rel="noopener noreferrer"><code>XMLHttpRequest.send()</code></a></li></ul><h3 id="处理请求头" tabindex="-1">处理请求头 <a class="header-anchor" href="#处理请求头" aria-hidden="true">#</a></h3><blockquote><p>由<code>send</code>方法中的参数解析引发的问题</p></blockquote><ul><li>支持配置请求头</li><li>在<code>open</code>之后以及<code>send</code>之前，通过<code>headers</code>来设置请求头</li></ul><blockquote><p>post body URLSearchParams will auto set request header Content-Type: application/x-www-form-urlencoded;charset=UTF-8</p></blockquote><h3 id="处理返回" tabindex="-1">处理返回 <a class="header-anchor" href="#处理返回" aria-hidden="true">#</a></h3><ul><li>处理响应头(为什么要处理响应头，是出于什么问题而考虑的。目前能想到的1个点：文件下载，通过响应头来获取文件名) <ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/getAllResponseHeaders" target="_blank" rel="noopener noreferrer">getAllResponseHeaders</a></li></ul></li><li>支持设置响应类型<a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseType" target="_blank" rel="noopener noreferrer"><code>responseType</code></a><ul><li>设置之后感觉没有用？</li><li>实际使用场景：文件下载，服务端返回文件流</li></ul></li><li>请求成功后返回给用户的数据格式</li></ul><h3 id="错误处理" tabindex="-1">错误处理 <a class="header-anchor" href="#错误处理" aria-hidden="true">#</a></h3><ul><li>网络错误</li><li>请求超时</li><li>非200~299状态码</li></ul><p>要给使用者详细的错误信息，而不仅仅只是一个字符串：</p><ul><li>message: 错误信息</li><li>request: <code>XMLHttpRequest</code>实例</li><li>response: 收到响应，但状态码不是<code>2xx</code></li><li>config: 请求配置项</li></ul><p>知识点：<a href="https://github.com/wangkaiwd/typescript-axios/blob/6ef097d9b1150d8669f954f53919206d2ed12fa4/lib/index.ts#L1-L5" target="_blank" rel="noopener noreferrer">汇总导出类型文件</a>，方便使用者使用类型</p><h3 id="扩展接口" tabindex="-1">扩展接口 <a class="header-anchor" href="#扩展接口" aria-hidden="true">#</a></h3><h4 id="api扩展" tabindex="-1"><code>api</code>扩展 <a class="header-anchor" href="#api扩展" aria-hidden="true">#</a></h4><p>为了让用户更加方便的调用，我们对使用方法进行了扩展：</p><ul><li>axios(config)</li><li>axios.verb(url,data?,config?)</li></ul><p>核心：<code>axios</code>本身是一个可以直接调用的函数，而且它也是一个对象，可以通过它的属性来调用不同的方法</p><h4 id="函数重载" tabindex="-1">函数重载 <a class="header-anchor" href="#函数重载" aria-hidden="true">#</a></h4><ul><li><a href="https://www.typescriptlang.org/docs/handbook/2/functions.html#function-overloads" target="_blank" rel="noopener noreferrer">function overload</a></li></ul><h4 id="响应支持泛型" tabindex="-1">响应支持泛型 <a class="header-anchor" href="#响应支持泛型" aria-hidden="true">#</a></h4><h4 id="知识点" tabindex="-1">知识点 <a class="header-anchor" href="#知识点" aria-hidden="true">#</a></h4><ul><li></li></ul><p>使用<a href="https://github.com/wangkaiwd/typescript-axios/blob/ff0d0046dfbe74708706b1212d19103797dd25a1/lib/helpers/extend.ts#L2-L7" target="_blank" rel="noopener noreferrer">扩展运算符实现属性对象属性的合并</a> ，并支持类型提示</p><ul><li></li></ul><p>使一个<a href="https://github.com/wangkaiwd/typescript-axios/blob/ff0d0046dfbe74708706b1212d19103797dd25a1/lib/axios.ts#L5-L9" target="_blank" rel="noopener noreferrer">变量既是函数又是对象</a></p><h3 id="拦截器" tabindex="-1">拦截器 <a class="header-anchor" href="#拦截器" aria-hidden="true">#</a></h3><ul><li>请求拦截器</li><li>响应拦截器</li></ul><h4 id="需求分析" tabindex="-1">需求分析 <a class="header-anchor" href="#需求分析" aria-hidden="true">#</a></h4><ul><li>设置公共的请求响应拦截器管理类</li></ul><h4 id="知识点-1" tabindex="-1">知识点 <a class="header-anchor" href="#知识点-1" aria-hidden="true">#</a></h4><ul><li><a href="https://github.com/wangkaiwd/typescript-axios/blob/2c0129bee059cd1e4ed4ce4b0a2268e572cad13d/lib/core/Axios.ts#L68-L69" target="_blank" rel="noopener noreferrer">review call promise then chain</a></li></ul><h3 id="配置化" tabindex="-1">配置化 <a class="header-anchor" href="#配置化" aria-hidden="true">#</a></h3><p><code>axios</code>每次在发起请求时都需要传入对应的配置，而有一些是可以全局配置的，而需要局部配置的内容可以与全局配置合并，覆盖掉全局配置。这样可以极大的方便用户使用</p><h4 id="合并配置的设计与实现" tabindex="-1">合并配置的设计与实现 <a class="header-anchor" href="#合并配置的设计与实现" aria-hidden="true">#</a></h4><p>要合并的配置：</p><ul><li>全局配置(所有请求)</li><li>实例配置(每个实例)</li><li>请求配置(每个请求)</li></ul><p>合并策略(<code>config1</code>和<code>config2</code>合并)：</p><ul><li>默认合并策略：以<code>config2</code>的值为主，如果<code>config2</code>有值就用<code>config2</code>，否则用<code>config1</code></li><li>只使用<code>config2</code>中的默认配置</li><li>合并复杂对象：遍历对象的每一项，通过默认合并策略进行合并</li></ul><h4 id="请求和响应配置化" tabindex="-1">请求和响应配置化 <a class="header-anchor" href="#请求和响应配置化" aria-hidden="true">#</a></h4><ul><li>配置响应和请求 <ul><li>transformRequest</li><li>transformResponse</li></ul></li></ul><h4 id="扩展axios-create静态接口" tabindex="-1">扩展<code>axios.create</code>静态接口 <a class="header-anchor" href="#扩展axios-create静态接口" aria-hidden="true">#</a></h4><ul><li>利用类型断言强制转换<code>axios</code>的类型</li></ul><h3 id="取消请求" tabindex="-1">取消请求 <a class="header-anchor" href="#取消请求" aria-hidden="true">#</a></h3><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/abort" target="_blank" rel="noopener noreferrer"><code>XMLHttpRequest.abort()</code></a></li><li><a href="https://github.com/wangkaiwd/node-core/blob/main/00.promise/promise-abort.js" target="_blank" rel="noopener noreferrer">how to cancel a pending promise</a><ul><li><a href="https://stackoverflow.com/questions/29478751/cancel-a-vanilla-ecmascript-6-promise-chain" target="_blank" rel="noopener noreferrer">Cancel a vanilla ECMAScript 6 Promise chain</a></li></ul></li></ul><p>难点：</p><ul><li>如何让用户取消请求</li></ul><div class="language-js"><pre><code><span class="token keyword">let</span> cancel <span class="token operator">=</span> <span class="token keyword">undefined</span>
<span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;xxx&#39;</span><span class="token punctuation">,</span> <span class="token function-variable function">cancelFn</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// c = xhr.abort.bind(xhr)</span>
    cancel <span class="token operator">=</span> c
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>CancelToken Class</li><li>isCancel</li></ul><h4 id="knowledge-points" tabindex="-1">knowledge points <a class="header-anchor" href="#knowledge-points" aria-hidden="true">#</a></h4><ul><li>the statement after <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/throw" target="_blank" rel="noopener noreferrer">throw</a> won&#39;t be executed</li></ul><h3 id="整体思路" tabindex="-1">整体思路 <a class="header-anchor" href="#整体思路" aria-hidden="true">#</a></h3><h3 id="复杂点" tabindex="-1">复杂点 <a class="header-anchor" href="#复杂点" aria-hidden="true">#</a></h3><ul><li>配置合并： <ul><li>策略模式</li><li>深度合并</li><li>拍平<code>headers</code></li></ul></li></ul><h3 id="更多功能" tabindex="-1">更多功能 <a class="header-anchor" href="#更多功能" aria-hidden="true">#</a></h3><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/withCredentials" target="_blank" rel="noopener noreferrer">XMLHttpRequest.withCredentials</a></li><li>xsrf: 同域并且设置了<code>withCredentials</code>时，在请求头添加<code>xsrf</code>相关字段 <ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener noreferrer">same-origin-policy</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener noreferrer">Cross-Origin Resource Sharing (CORS)</a><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Origin" target="_blank" rel="noopener noreferrer">origin</a></li><li><a href="https://fetch.spec.whatwg.org/#http-responses" target="_blank" rel="noopener noreferrer">cors http response header</a></li></ul></li></ul></li></ul><h4 id="上传和下载" tabindex="-1">上传和下载 <a class="header-anchor" href="#上传和下载" aria-hidden="true">#</a></h4><ul><li>下载功能需要服务端支持，否则<code>total</code>为0</li></ul><h3 id="authorization" tabindex="-1">Authorization <a class="header-anchor" href="#authorization" aria-hidden="true">#</a></h3><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Authorization#basic_authentication" target="_blank" rel="noopener noreferrer">basic authentication</a></li></ul><h3 id="materials" tabindex="-1">materials <a class="header-anchor" href="#materials" aria-hidden="true">#</a></h3><ul><li><a href="https://github.com/char1eschen/ts-axios" target="_blank" rel="noopener noreferrer">https://github.com/char1eschen/ts-axios</a></li></ul></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><!----></div></div><div class="updated" data-v-fb8d84c6><!----></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/typescript-axios/publish" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>publish</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/typescript-axios/notes" data-v-38ede35f><span class="text" data-v-38ede35f>notes</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"build.md\":\"23f43f15\",\"index.md\":\"974e6554\",\"notes.md\":\"4419c16c\",\"publish.md\":\"74146320\",\"requirement.md\":\"9d6431d0\",\"test-case.md\":\"c1ebf19f\"}")</script>
    <script type="module" async src="/typescript-axios/assets/app.9770fa93.js"></script>
    
  </body>
</html>